generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // schemas  = ["auth", "comments", "notification", "postLikes", "posts", "profiles", "public", "relationships", "saved", "store"]
}

// --------------------------------------------------
// ENUMS
// --------------------------------------------------
enum MediaType {
  IMAGE
  VIDEO
  DOCUMENT
  AUDIO
  OTHER
}

enum LineageType {
  FAMILY
  CLAN
  SURNAME_LINE
  TRIBE
}

enum LineageRole {
  ANCESTOR
  DESCENDANT
  SPOUSE
  EXTENDED
}

enum KinshipType {
  PARENT
  CHILD
  SIBLING
  SPOUSE
  GRANDPARENT
  GRANDCHILD
  COUSIN
  UNCLE_AUNT
  NEPHEW_NIECE
  OTHER
}

enum PostVisibility {
  PUBLIC
  FOLLOWERS
  LINEAGE_ONLY
  PRIVATE
}

enum ReactionType {
  LIKE
  LOVE
  LAUGH
  ANGRY
  SAD
}

enum NotificationType {
  FOLLOW
  LIKE
  COMMENT
  MENTION
  MESSAGE
  LINEAGE_INVITE
  LINEAGE_ACCEPT
}

// --------------------------------------------------
// CORE IDENTITY
// --------------------------------------------------

model Profile {
  id     String @id @default(uuid()) @db.Uuid
  userId String @unique @db.Uuid // points to auth.users.id

  // info
  firstName   String    @default("")
  lastName    String    @default("")
  username    String    @unique
  gender      String?
  dateOfBirth DateTime?

  interests ProfileInterest[]

  // location
  country     String? @default("")
  city        String? @default("")
  district    String? @default("")
  location    String  @default("")
  bio         String  @default("Connecting with amazing people and building great things together.")
  countryCode String?

  // images
  avatarUrl String?
  coverUrl  String?

  // linage
  lineageMainSurname String?
  lineageRootVillage String?

  //
  isVerified Boolean  @default(false)
  createdAt  DateTime @default(now()) @db.Timestamptz
  updatedAt  DateTime @updatedAt @db.Timestamptz

  posts         Post[]
  comments      Comment[]
  messages      Message[]
  messageReads  MessageRead[]
  postReactions PostReaction[]

  // Relations
  settings                ProfileSettings?
  lineageMemberships      LineageMembership[]
  kinshipsA               Kinship[]                 @relation("ProfileAKinships")
  kinshipsB               Kinship[]                 @relation("ProfileBKinships")
  commentReactions        CommentReaction[]
  followsAsFollower       Follow[]                  @relation("FollowsFollower")
  followsAsFollowee       Follow[]                  @relation("FollowsFollowee")
  blocksAsBlocker         Block[]                   @relation("BlocksBlocker")
  blocksAsBlocked         Block[]                   @relation("BlocksBlocked")
  mutesAsMuter            Mute[]                    @relation("MutesMuter")
  mutesAsMuted            Mute[]                    @relation("MutesMuted")
  conversationsOwned      Conversation[]            @relation("ConversationsCreatedBy")
  conversationMembers     ConversationParticipant[]
  notifications           Notification[]            @relation("NotificationsRecipient")
  notificationsAsActor    Notification[]            @relation("NotificationsActor")
  lineagesCreated         Lineage[]                 @relation("LineagesCreatedBy")
  lineageMembershipsAdded LineageMembership[]       @relation("LineageMembershipsAddedBy")
}

model ProfileSettings {
  profileId             String   @id @db.Uuid
  profile               Profile  @relation(fields: [profileId], references: [id])
  isPrivate             Boolean  @default(false)
  showLastSeen          Boolean  @default(true)
  allowTagging          Boolean  @default(true)
  allowMessagesFrom     String   @default("everyone") // 'everyone' | 'followers' | 'none'
  discoveryAllowLineage Boolean  @default(true)
  createdAt             DateTime @default(now()) @db.Timestamptz
  updatedAt             DateTime @updatedAt @db.Timestamptz
}

// --------------------------------------------------
// LINEAGE / FAMILY GRAPH
// --------------------------------------------------

model Lineage {
  id             String      @id @default(uuid()) @db.Uuid
  name           String
  type           LineageType @default(FAMILY)
  primarySurname String?
  rootVillage    String?
  rootRegion     String?
  description    String?
  createdById    String?     @db.Uuid
  createdBy      Profile?    @relation("LineagesCreatedBy", fields: [createdById], references: [id])
  createdAt      DateTime    @default(now()) @db.Timestamptz
  updatedAt      DateTime    @updatedAt @db.Timestamptz

  memberships LineageMembership[]
  posts       Post[]

  notifications Notification[]
}

model LineageMembership {
  id               String      @id @default(uuid()) @db.Uuid
  lineageId        String      @db.Uuid
  profileId        String      @db.Uuid
  role             LineageRole @default(DESCENDANT)
  generation       Int?
  isPrimaryLineage Boolean     @default(false)
  addedById        String?     @db.Uuid
  createdAt        DateTime    @default(now()) @db.Timestamptz

  lineage Lineage  @relation(fields: [lineageId], references: [id])
  profile Profile  @relation(fields: [profileId], references: [id])
  addedBy Profile? @relation("LineageMembershipsAddedBy", fields: [addedById], references: [id])

  @@unique([lineageId, profileId])
}

model Kinship {
  id           String      @id @default(uuid()) @db.Uuid
  profileIdA   String      @db.Uuid
  profileIdB   String      @db.Uuid
  relationAtoB KinshipType
  verified     Boolean     @default(false)
  verifiedById String?     @db.Uuid
  createdAt    DateTime    @default(now()) @db.Timestamptz

  profileA Profile @relation("ProfileAKinships", fields: [profileIdA], references: [id])
  profileB Profile @relation("ProfileBKinships", fields: [profileIdB], references: [id])

  @@unique([profileIdA, profileIdB, relationAtoB])
}

// --------------------------------------------------
// SOCIAL GRAPH (FOLLOW / BLOCK / MUTE)
// --------------------------------------------------

model Follow {
  id         String   @id @default(uuid()) @db.Uuid
  followerId String   @db.Uuid
  followeeId String   @db.Uuid
  createdAt  DateTime @default(now()) @db.Timestamptz

  follower Profile @relation("FollowsFollower", fields: [followerId], references: [id])
  followee Profile @relation("FollowsFollowee", fields: [followeeId], references: [id])

  @@unique([followerId, followeeId])
  @@index([followeeId]) // quick “followers of X”
  @@index([followerId]) // quick “who X follows”
}

model Block {
  id        String   @id @default(uuid()) @db.Uuid
  blockerId String   @db.Uuid
  blockedId String   @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz

  blocker Profile @relation("BlocksBlocker", fields: [blockerId], references: [id])
  blocked Profile @relation("BlocksBlocked", fields: [blockedId], references: [id])

  @@unique([blockerId, blockedId])
}

model Mute {
  id        String   @id @default(uuid()) @db.Uuid
  muterId   String   @db.Uuid
  mutedId   String   @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz

  muter Profile @relation("MutesMuter", fields: [muterId], references: [id])
  muted Profile @relation("MutesMuted", fields: [mutedId], references: [id])

  @@unique([muterId, mutedId])
}

// --------------------------------------------------
// CONTENT: POSTS / MEDIA / COMMENTS / REACTIONS
// --------------------------------------------------

model Post {
  id           String         @id @default(uuid()) @db.Uuid
  profileId    String         @db.Uuid
  content      String?
  visibility   PostVisibility @default(PUBLIC)
  locationText String?
  lineageId    String?        @db.Uuid
  commentCount Int            @default(0)
  likeCount    Int            @default(0)
  shareCount   Int            @default(0)
  createdAt    DateTime       @default(now()) @db.Timestamptz
  updatedAt    DateTime       @updatedAt @db.Timestamptz

  author     Profile        @relation(fields: [profileId], references: [id])
  lineage    Lineage?       @relation(fields: [lineageId], references: [id])
  comments   Comment[]
  reactions  PostReaction[]
  mediaFiles MediaFile[]

  notifications Notification[]
}

model MediaFile {
  id        String    @id @default(uuid()) @db.Uuid
  postId    String    @db.Uuid
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  type      MediaType
  url       String
  mimeType  String
  width     Int?
  height    Int?
  sizeBytes BigInt    @db.BigInt
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([postId])
}

model Comment {
  id              String   @id @default(uuid()) @db.Uuid
  postId          String   @db.Uuid
  profileId       String   @db.Uuid
  parentCommentId String?  @db.Uuid
  content         String
  likeCount       Int      @default(0)
  createdAt       DateTime @default(now()) @db.Timestamptz

  post          Post              @relation(fields: [postId], references: [id])
  author        Profile           @relation(fields: [profileId], references: [id])
  parentComment Comment?          @relation("CommentToReplies", fields: [parentCommentId], references: [id])
  replies       Comment[]         @relation("CommentToReplies")
  reactions     CommentReaction[]

  notifications Notification[]
}

model PostReaction {
  id        String       @id @default(uuid()) @db.Uuid
  postId    String       @db.Uuid
  profileId String       @db.Uuid
  type      ReactionType @default(LIKE)
  createdAt DateTime     @default(now()) @db.Timestamptz

  post    Post    @relation(fields: [postId], references: [id])
  profile Profile @relation(fields: [profileId], references: [id])

  @@unique([postId, profileId])
}

model CommentReaction {
  id        String       @id @default(uuid()) @db.Uuid
  commentId String       @db.Uuid
  profileId String       @db.Uuid
  type      ReactionType @default(LIKE)
  createdAt DateTime     @default(now()) @db.Timestamptz

  comment Comment @relation(fields: [commentId], references: [id])
  profile Profile @relation(fields: [profileId], references: [id])

  @@unique([commentId, profileId])
}

// --------------------------------------------------
// MESSAGING
// --------------------------------------------------

model Conversation {
  id          String   @id @default(uuid()) @db.Uuid
  isGroup     Boolean  @default(false)
  title       String?
  createdById String?  @db.Uuid
  createdAt   DateTime @default(now()) @db.Timestamptz

  createdBy    Profile?                  @relation("ConversationsCreatedBy", fields: [createdById], references: [id])
  participants ConversationParticipant[]
  messages     Message[]
}

model ConversationParticipant {
  id             String    @id @default(uuid()) @db.Uuid
  conversationId String    @db.Uuid
  profileId      String    @db.Uuid
  role           String    @default("member")
  lastReadAt     DateTime?
  joinedAt       DateTime  @default(now()) @db.Timestamptz

  conversation Conversation @relation(fields: [conversationId], references: [id])
  profile      Profile      @relation(fields: [profileId], references: [id])

  @@unique([conversationId, profileId])
}

model Message {
  id             String    @id @default(uuid()) @db.Uuid
  conversationId String    @db.Uuid
  senderId       String    @db.Uuid
  content        String?
  mediaUrl       String?
  createdAt      DateTime  @default(now()) @db.Timestamptz
  deletedAt      DateTime?

  timestamp DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id])
  sender       Profile      @relation(fields: [senderId], references: [id])

  reads         MessageRead[]
  notifications Notification[]
}

// --------------------------------------------------
// NOTIFICATIONS
// --------------------------------------------------

model Notification {
  id          String           @id @default(uuid()) @db.Uuid
  recipientId String           @db.Uuid
  actorId     String?          @db.Uuid
  type        NotificationType
  postId      String?          @db.Uuid
  commentId   String?          @db.Uuid
  lineageId   String?          @db.Uuid
  messageId   String?          @db.Uuid
  isRead      Boolean          @default(false)
  createdAt   DateTime         @default(now()) @db.Timestamptz

  recipient Profile  @relation("NotificationsRecipient", fields: [recipientId], references: [id])
  actor     Profile? @relation("NotificationsActor", fields: [actorId], references: [id])
  post      Post?    @relation(fields: [postId], references: [id])
  comment   Comment? @relation(fields: [commentId], references: [id])
  lineage   Lineage? @relation(fields: [lineageId], references: [id])
  message   Message? @relation(fields: [messageId], references: [id])
}

// --------------------------------------------------
// INTERESTS
// --------------------------------------------------
model Interest {
  id   String @id @default(uuid()) @db.Uuid
  name String @unique

  users ProfileInterest[]
}

// Join table between User and Interest
model ProfileInterest {
  userId     String   @db.Uuid
  interestId String   @db.Uuid
  createdAt  DateTime @default(now())

  user     Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)
  interest Interest @relation(fields: [interestId], references: [id], onDelete: Cascade)

  @@id([userId, interestId])
  @@index([interestId])
}

model MessageRead {
  messageId String   @db.Uuid
  userId    String   @db.Uuid
  readAt    DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([messageId, userId])
  @@index([userId])
}
