generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Profile {
  id     String @id @default(uuid()) @db.Uuid
  userId String @unique @db.Uuid

  firstName String @default("")
  lastName  String @default("")
  fullName  String?
  username  String @unique

  gender       String?
  dateOfBirth  DateTime?
  ethnicity    String?
  email        String                @unique
  bio          String?               @default("")
  profession   String?
  avatarUrl    String?
  coverUrl     String?
  interests    ProfileInterest[]
  appInterests ProfileAppInterests[]

  //. LOCATION
  country     String? @default("")
  city        String? @default("")
  district    String? @default("")
  location    String? @default("")
  countryCode String?

  isProfileComplete Boolean @default(false)

  lineageMainSurname String?
  lineageRootVillage String?
  isVerified         Boolean @default(false)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  // CLANS
  rootClan  RootClans? 
  clan ProfileClan[]
  lineage String[]

  //MESSAGE
  messages             Message[]
  messageReads         MessageRead[]

 // NOTIFICATION
  notificationsAsActor Notification[] @relation("NotificationsActor")
  notifications        Notification[] @relation("NotificationsRecipient")

  conversationsOwned  Conversation[]            @relation("ConversationsCreatedBy")
  conversationMembers ConversationParticipant[]

  //POST
  posts         Post[]
  postReactions PostReaction[]
  product       Product[]

  //COMMENTS
  comments         Comment[]
  commentReactions CommentReaction[]

  //SETTING
  settings        ProfileSettings?
  blocksAsBlocked Block[]          @relation("BlocksBlocked")
  blocksAsBlocker Block[]          @relation("BlocksBlocker")
  mutesAsMuted         Mute[]         @relation("MutesMuted")
  mutesAsMuter         Mute[]         @relation("MutesMuter")

  //FRIENDS
  sentFriendRequests     FriendRequest[] @relation("FriendRequestsSent")
  receivedFriendRequests FriendRequest[] @relation("FriendRequestsReceived")
  friendshipsA           Friendship[]    @relation("FriendshipA")
  friendshipsB           Friendship[]    @relation("FriendshipB")

  @@map("profile")
}

model ProfileSettings {
  profileId             String   @id @db.Uuid
  isPrivate             Boolean  @default(false)
  showLastSeen          Boolean  @default(true)
  allowTagging          Boolean  @default(true)
  allowMessagesFrom     String   @default("everyone")
  discoveryAllowLineage Boolean  @default(true)
  createdAt             DateTime @default(now()) @db.Timestamptz(6)
  updatedAt             DateTime @updatedAt @db.Timestamptz(6)
  profile               Profile  @relation(fields: [profileId], references: [id])
}

model FriendRequest {
  id          String              @id @default(uuid()) @db.Uuid
  requesterId String              @db.Uuid
  addresseeId String              @db.Uuid
  status      FriendRequestStatus @default(PENDING)
  createdAt   DateTime            @default(now()) @db.Timestamptz(6)
  respondedAt DateTime?           @db.Timestamptz(6)

  notifications Notification[]

  requester Profile @relation("FriendRequestsSent", fields: [requesterId], references: [id])
  addressee Profile @relation("FriendRequestsReceived", fields: [addresseeId], references: [id])

  @@unique([requesterId, addresseeId])
  @@index([addresseeId, status])
  @@index([requesterId, status])
}

model Friendship {
  id        String   @id @default(uuid()) @db.Uuid
  userAId   String   @db.Uuid
  userBId   String   @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  userA Profile @relation("FriendshipA", fields: [userAId], references: [id])
  userB Profile @relation("FriendshipB", fields: [userBId], references: [id])

  @@unique([userAId, userBId])
  @@index([userAId])
  @@index([userBId])
}

model Clan {
  id      String        @id @default(uuid()) @db.Uuid
  name    String        @unique
  members ProfileClan[]
}

model ProfileClan {
  id        String @id @default(uuid()) @db.Uuid
  profileId String @db.Uuid
  clanId    String @db.Uuid
  order     Int

  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  clan    Clan    @relation(fields: [clanId], references: [id], onDelete: Cascade)

  @@unique([profileId, order])
}

model Block {
  id        String   @id @default(uuid()) @db.Uuid
  blockerId String   @db.Uuid
  blockedId String   @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  blocked   Profile  @relation("BlocksBlocked", fields: [blockedId], references: [id])
  blocker   Profile  @relation("BlocksBlocker", fields: [blockerId], references: [id])

  @@unique([blockerId, blockedId])
}

model Mute {
  id        String   @id @default(uuid()) @db.Uuid
  muterId   String   @db.Uuid
  mutedId   String   @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  muted     Profile  @relation("MutesMuted", fields: [mutedId], references: [id])
  muter     Profile  @relation("MutesMuter", fields: [muterId], references: [id])

  @@unique([muterId, mutedId])
}

model Post {
  id            String         @id @default(uuid()) @db.Uuid
  profileId     String         @db.Uuid
  content       String?
  visibility    PostVisibility @default(PUBLIC)
  locationText  String?
  // lineageId     String?        @db.Uuid
  commentCount  Int            @default(0)
  likeCount     Int            @default(0)
  shareCount    Int            @default(0)
  createdAt     DateTime       @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime       @updatedAt @db.Timestamptz(6)
  comments      Comment[]
  mediaFiles    MediaFile[]
  notifications Notification[]
  // lineage       Lineage?       @relation(fields: [lineageId], references: [id])
  author        Profile        @relation(fields: [profileId], references: [id])
  reactions     PostReaction[]
}

model MediaFile {
  id        String    @id @default(uuid()) @db.Uuid
  postId    String    @db.Uuid
  type      MediaType
  url       String
  mimeType  String
  width     Int?
  height    Int?
  sizeBytes Int
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
}

model Comment {
  id              String            @id @default(uuid()) @db.Uuid
  postId          String            @db.Uuid
  profileId       String            @db.Uuid
  parentCommentId String?           @db.Uuid
  content         String
  likeCount       Int               @default(0)
  createdAt       DateTime          @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime          @default(now()) @updatedAt
  parentComment   Comment?          @relation("CommentToReplies", fields: [parentCommentId], references: [id])
  replies         Comment[]         @relation("CommentToReplies")
  post            Post              @relation(fields: [postId], references: [id])
  author          Profile           @relation(fields: [profileId], references: [id])
  reactions       CommentReaction[]
  notifications   Notification[]

  @@index([postId, parentCommentId, createdAt])
  @@index([parentCommentId, createdAt])
}

model PostReaction {
  id        String       @id @default(uuid()) @db.Uuid
  postId    String       @db.Uuid
  profileId String       @db.Uuid
  type      ReactionType @default(LIKE)
  createdAt DateTime     @default(now()) @db.Timestamptz(6)
  post      Post         @relation(fields: [postId], references: [id])
  profile   Profile      @relation(fields: [profileId], references: [id])

  @@unique([postId, profileId])
}

model CommentReaction {
  id        String       @id @default(uuid()) @db.Uuid
  commentId String       @db.Uuid
  profileId String       @db.Uuid
  type      ReactionType @default(LIKE)
  createdAt DateTime     @default(now()) @db.Timestamptz(6)
  comment   Comment      @relation(fields: [commentId], references: [id])
  profile   Profile      @relation(fields: [profileId], references: [id])

  @@unique([commentId, profileId])
}

model Conversation {
  id           String                    @id @default(uuid()) @db.Uuid
  isGroup      Boolean                   @default(false)
  title        String?
  createdById  String?                   @db.Uuid
  createdAt    DateTime                  @default(now()) @db.Timestamptz(6)
  createdBy    Profile?                  @relation("ConversationsCreatedBy", fields: [createdById], references: [id])
  participants ConversationParticipant[]
  messages     Message[]
}

model ConversationParticipant {
  id             String       @id @default(uuid()) @db.Uuid
  conversationId String       @db.Uuid
  profileId      String       @db.Uuid
  role           String       @default("member")
  lastReadAt     DateTime?
  joinedAt       DateTime     @default(now()) @db.Timestamptz(6)
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  profile        Profile      @relation(fields: [profileId], references: [id])

  @@unique([conversationId, profileId])
}

model Message {
  id             String         @id @default(uuid()) @db.Uuid
  conversationId String         @db.Uuid
  senderId       String         @db.Uuid
  content        String?
  mediaUrl       String?
  createdAt      DateTime       @default(now()) @db.Timestamptz(6)
  deletedAt      DateTime?
  timestamp      DateTime       @default(now())
  conversation   Conversation   @relation(fields: [conversationId], references: [id])
  sender         Profile        @relation(fields: [senderId], references: [id])
  reads          MessageRead[]
  notifications  Notification[]
}

model Notification {
  id          String           @id @default(uuid()) @db.Uuid
  recipientId String           @db.Uuid
  senderId    String?          @db.Uuid
  type        NotificationType
  postId      String?          @db.Uuid
  commentId   String?          @db.Uuid
  requestId   String?          @db.Uuid
  lineageId   String?          @db.Uuid
  messageId   String?          @db.Uuid
  isRead      Boolean          @default(false)
  createdAt   DateTime         @default(now()) @db.Timestamptz(6)
  sender      Profile?         @relation("NotificationsActor", fields: [senderId], references: [id])
  comment     Comment?         @relation(fields: [commentId], references: [id])
  // lineage     Lineage?         @relation(fields: [lineageId], references: [id])
  request     FriendRequest?   @relation(fields: [requestId], references: [id])
  message     Message?         @relation(fields: [messageId], references: [id])
  post        Post?            @relation(fields: [postId], references: [id])
  recipient   Profile          @relation("NotificationsRecipient", fields: [recipientId], references: [id])
}

model Interest {
  id    String            @id @default(uuid()) @db.Uuid
  name  String            @unique
  users ProfileInterest[]
}

model AppInterest {
  id    String                @id @default(uuid()) @db.Uuid
  name  String                @unique
  users ProfileAppInterests[]
}

model ProfileInterest {
  userId     String   @db.Uuid
  interestId String   @db.Uuid
  createdAt  DateTime @default(now())
  interest   Interest @relation(fields: [interestId], references: [id], onDelete: Cascade)
  user       Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, interestId])
  @@index([interestId])
}

model ProfileAppInterests {
  userId     String      @db.Uuid
  interestId String      @db.Uuid
  createdAt  DateTime    @default(now())
  interest   AppInterest @relation(fields: [interestId], references: [id], onDelete: Cascade)
  user       Profile     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, interestId])
  @@index([interestId])
}

model MessageRead {
  messageId String   @db.Uuid
  userId    String   @db.Uuid
  readAt    DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([messageId, userId])
  @@index([userId])
}

model Product {
  id           String           @id @default(uuid()) @db.Uuid
  sellerId     String           @db.Uuid
  visibility   PostVisibility   @default(PUBLIC)
  title        String
  price        Int
  currency     String           @default("GBP")
  description  String
  category     String
  condition    ProductCondition @default(USED_GOOD)
  negotiable   Boolean          @default(true)
  availability Available
  status       ListingStatus    @default(DRAFT)
  publishedAt  DateTime?
  expiresAt    DateTime?
  deletedAt    DateTime?
  country      String?          @default("")
  city         String?          @default("")
  district     String?          @default("")
  locationText String?
  lat          Float?
  lng          Float?
  viewCount    Int              @default(0)
  saveCount    Int              @default(0)
  createdAt    DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime         @updatedAt @db.Timestamptz(6)
  seller       Profile          @relation(fields: [sellerId], references: [id])
  media        ProductMedia[]

  @@index([sellerId, createdAt])
  @@index([status, createdAt])
  @@index([city, status])
}

model ProductMedia {
  id         String   @id @default(uuid()) @db.Uuid
  productId  String   @db.Uuid
  url        String
  mimeType   String
  width      Int?
  height     Int?
  sizeBytes  Int
  orderIndex Int      @default(0)
  isCover    Boolean  @default(false)
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, orderIndex])
}

enum MediaType {
  IMAGE
  VIDEO
  DOCUMENT
  AUDIO
  OTHER
}

// enum LineageType {
//   FAMILY
//   CLAN
//   SURNAME_LINE
//   TRIBE
// }

// enum LineageRole {
//   ANCESTOR
//   DESCENDANT
//   SPOUSE
//   EXTENDED
// }

// enum KinshipType {
//   PARENT
//   CHILD
//   SIBLING
//   SPOUSE
//   GRANDPARENT
//   GRANDCHILD
//   COUSIN
//   UNCLE_AUNT
//   NEPHEW_NIECE
//   OTHER
// }

enum PostVisibility {
  PUBLIC
  FOLLOWERS
  LINEAGE_ONLY
  PRIVATE
}

enum ReactionType {
  LIKE
  LOVE
  LAUGH
  ANGRY
  SAD
}

enum NotificationType {
  FRIEND_REQUEST
  LIKE
  COMMENT
  MENTION
  MESSAGE
  LINEAGE_INVITE
  LINEAGE_ACCEPT
}

enum ListingStatus {
  DRAFT
  ACTIVE
  PAUSED
  SOLD
  DELETED
}

enum ProductCondition {
  NEW
  USED_LIKE_NEW
  USED_GOOD
  USED_FAIR
}

enum Available {
  IMMEDIATLY
  IN_A_WEEK
  IN_A_MONTH
  OTHER
}

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  DECLINED
  CANCELLED
}

enum RootClans {
  DAROOD
  HAWIYE
  GARDHEERE
  DIR
  ISAAQ
  RAXANWEYN
  SHEEKHAL
}
